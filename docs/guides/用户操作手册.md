# OpenSkills 用户操作手册

本文档面向使用 OpenSkills 扩展的最终用户，说明日常操作、Cursor CLI 登录流程以及常见权限与环境问题。

---

## 一、日常操作入口

| 操作       | 入口 |
|------------|------|
| 触发唤醒   | 命令面板 `OpenSkills: Trigger Wake`，或侧边栏 OpenSkills → 相关入口 |
| 诊断       | `OpenSkills: Diagnose` 或 `OpenSkills: Open Diagnose Panel` |
| 健康检查   | `OpenSkills: Health Check` |
| 初始化     | `OpenSkills: Initialize` |
| 打开 Web   | `OpenSkills: Open Web UI` |

更多命令见 `QUICK_REFERENCE.md`。

### 1.1 管理员面板「手动唤醒」重要说明

**在管理员面板点击「手动唤醒管理员」时，能否真正执行 OpenSkills: Trigger Wake 并启动 Agent，取决于打开方式：**

| 打开方式 | 是否执行 Trigger Wake | 是否启动 Agent |
|----------|------------------------|----------------|
| **Cursor 扩展面板内**（侧边栏 OpenSkills 图标 → 进入管理员页面） | ✅ 会执行 | ✅ 会启动 |
| **独立浏览器**（点击「在浏览器中打开」后访问 /admin） | ❌ 不执行 | ❌ 不启动 |

- 在**独立浏览器**中点击「手动唤醒管理员」时，只会触发 API 记录唤醒事件，**不会**执行 `OpenSkills: Trigger Wake`，也**不会**启动 Cursor Agent。
- 要真正启动 Agent，请任选其一：
  1. **在 Cursor 扩展面板内**打开管理员页面，再点击「手动唤醒管理员」；
  2. 或直接运行命令面板中的 **`OpenSkills: Trigger Wake`**。

---

## 二、Cursor CLI 登录（必读）

### 2.1 编辑器登录 ≠ CLI 登录

- **Cursor 编辑器**：在 Cursor 里登录的是“编辑器账号”，用于使用 Cursor IDE 功能。
- **Cursor Agent CLI**：在终端里运行的 `agent` 命令使用**另一套独立登录**，与编辑器登录**不共享**。
- 因此：**即使已在 Cursor 中登录，首次使用「触发唤醒」时，CLI 仍可能要求单独登录一次。**

### 2.2 首次使用 CLI 时的登录流程

1. 执行 **「OpenSkills: Trigger Wake」**（或其它会调用 `agent chat` 的操作）。
2. 打开名为 **「OpenSkills Wake」** 的终端，终端中会出现类似提示：
   ```text
   Signing in
   If your browser didn't open, click this link to log in:
   https://cursor.com/loginDeepControl?challenge=...&uuid=...&mode=login&redirectTarget=cli
   ```
3. **请点击终端里显示的那条链接**（或复制到浏览器打开），在浏览器中完成 Cursor 账号登录。
4. 登录成功后，**CLI 会记住登录状态**，之后一般无需再次登录。

### 2.3 扩展内快捷入口

- 若终端已出现「Signing in」和链接，**优先直接点击终端中的链接**（该链接为当前会话专用，最可靠）。
- 需要查看官方说明时，可使用扩展命令：**「OpenSkills: 打开 Cursor CLI 登录页」**（命令面板中搜索），会打开 Cursor CLI 认证说明页。

### 2.4 小结

| 项目     | 说明 |
|----------|------|
| 登录关系 | 编辑器已登录 ≠ CLI 已登录，需单独完成一次 CLI 登录 |
| 登录时机 | 首次执行「触发唤醒」等使用 `agent` 的命令时 |
| 操作方式 | 点击终端里「Signing in」下方给出的链接，在浏览器中登录 |
| 登录次数 | 通常只需一次，后续会自动使用已保存的 CLI 登录状态 |

### 2.5 唤醒时「没有 web 权限」或请求被拒绝

- **现象**：触发唤醒后，Agent 卡在「没有 web 权限」或无法访问 API/网页。
- **原因**：Cursor Agent 在终端中运行时，访问本地 API（如 `http://localhost:3847`）或网页可能受 Cursor 的「Web / 网络」权限控制。
- **处理**：
  1. 在 Cursor 设置或 Agent 相关权限中，允许 **Web 访问** 或 **本地网络**（如 `localhost`）。
  2. 扩展会在唤醒指令中注入**当前 API 基地址**（来自扩展配置/内嵌服务端口），请勿使用 `localhost:3000`，除非你已将 API 配置为该端口。
  3. 若端口已修改，请在 Cursor 设置中配置 **OpenSkills: Api Url** 或 **OpenSkills: Api Port**，扩展与唤醒指令会使用该配置。

---

## 三、CLI 可能没有某些命令执行权限的问题

在使用 Cursor Agent CLI（如「触发唤醒」）时，可能遇到“命令执行失败”“找不到命令”或“权限不足”等现象。常见原因与处理如下。

### 3.1 终端环境与 PATH

- **现象**：在你自己打开的 PowerShell 里运行 `agent --version` 正常，但扩展内诊断/唤醒仍报「Agent CLI 不可用」或执行失败。
- **原因**：扩展通过内部进程启动终端时，继承的 PATH/环境可能与你在桌面打开的终端不同（例如未加载你的 Profile、未包含 `~/.local/bin` 等）。
- **处理**：
  1. 在 Cursor 设置中配置 **「OpenSkills: Agent Cli Path」**，将 `agent` 的完整路径填进去（例如 `C:\Users\你的用户名\.local\bin\agent.exe`），让扩展固定使用该路径。
  2. 或将安装 `agent` 的目录加入**系统或用户环境变量 PATH**，并**重启 Cursor** 后再试。

### 3.2 杀毒软件 / 安全软件拦截

- **现象**：扩展自动下载 ripgrep 或其它依赖时失败，报 `EPERM`、`operation not permitted`，或解压/复制到本地目录失败。
- **原因**：安全软件可能拦截“由编辑器/扩展写入特定目录”或“从网络下载并解压”的行为。
- **处理**：
  1. 在杀毒/安全软件中为 Cursor 或 VS Code 添加信任或白名单。
  2. 或将 OpenSkills 使用的目录（如 `%LOCALAPPDATA%\OpenSkills`）加入排除项。
  3. 若自动安装依赖一直失败，可改为**手动安装依赖**（如 ripgrep），并将可执行文件所在目录加入 PATH；扩展会优先使用系统 PATH 中的命令。

### 3.3 目录与文件权限

- **现象**：写入 `%LOCALAPPDATA%\OpenSkills`、项目下的 `.openskills` 或 `.cursor` 时报权限错误。
- **原因**：当前用户对目标目录无写权限、目录只读、或被其它进程占用。
- **处理**：
  1. 确认当前用户对该目录有写入权限（可尝试在资源管理器中新建/删除文件测试）。
  2. 若目录被占用，关闭可能占用该目录的程序或终端，再重试。
  3. 不要将 OpenSkills 或 Cursor 的工作目录放在需要管理员权限或同步盘（如某些网盘）的路径下，以免出现权限或锁定问题。

### 3.4 依赖命令不可用（如 ripgrep）

- **现象**：CLI 已安装且已登录，但执行「触发唤醒」时报错，提示缺少 `rg`（ripgrep）等命令。
- **原因**：Cursor Agent CLI 依赖 ripgrep 等工具；若未安装或未在 PATH 中，相关命令会失败。
- **处理**：
  1. 扩展会尝试**自动安装** ripgrep（如通过 winget/choco/scoop 或从 GitHub 下载）。若自动安装失败，请查看 **OpenSkills 输出通道** 中的 `[ripgrep 下载]` 日志，根据报错排查（网络、权限、杀毒等）。
  2. **手动安装**：在 Windows 上可用 `winget install BurntSushi.ripgrep.GNU`、`choco install ripgrep` 或 `scoop install ripgrep`，或将 [ripgrep 发行包](https://github.com/BurntSushi/ripgrep/releases) 解压后将 `rg.exe` 所在目录加入 PATH。

### 3.5 UAC / 管理员权限

- **现象**：在“以管理员身份运行”的 Cursor 中一切正常，在普通用户下则失败（或反之）。
- **原因**：不同权限下 PATH、可写目录、安全策略可能不同。
- **建议**：尽量在**同一权限级别**下使用 Cursor 和终端（通常以普通用户即可）；若必须用管理员环境，请确保 `agent` 与依赖均在该环境下可用且 PATH 一致。

### 3.6 小结

| 问题类型       | 可能原因           | 建议处理 |
|----------------|--------------------|----------|
| 找不到 `agent` | PATH 未包含 CLI 路径 | 配置 Agent Cli Path 或把安装目录加入 PATH，重启 Cursor |
| 下载/解压失败  | 杀毒或权限         | 信任 Cursor/目录、或改用手动安装依赖 |
| 写入失败       | 目录权限/只读/占用 | 检查目录权限与占用，避免同步盘或受限路径 |
| 缺少 rg 等命令 | 未安装或未在 PATH  | 查看扩展输出日志，自动安装失败则手动安装并加入 PATH |
| 管理员/普通用户不一致 | 环境不一致       | 统一在同一权限级别下使用 |

遇到具体报错时，可先运行 **「OpenSkills: Diagnose」** 或 **「OpenSkills: Open Diagnose Panel」** 查看诊断结果，再结合 **「OpenSkills」输出通道** 的日志排查；更多故障排除见 `TROUBLESHOOTING.md`。

---

## 四、相关文档

- **快速参考**：`QUICK_REFERENCE.md`（启动、修复命令、CLI 安装、Skills-admin 与唤醒）
- **如何唤醒**：`如何唤醒skills-admin.md`（安装 CLI、手动唤醒、验证）
- **故障排除**：`TROUBLESHOOTING.md`（环境、端口、API 等）
- **架构说明**：`docs/ARCHITECTURE_FIX.md`（唤醒与 CLI 的关系）
